name: Automated Test Fix with Claude Code

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    outputs:
      tests_failed: ${{ steps.test.outcome == 'failure' }}
      issue_number: ${{ steps.create_issue.outputs.issue_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-html
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests
        id: test
        continue-on-error: true
        run: |
          pytest -v \
            --json-report \
            --json-report-file=test-report.json \
            --html=test-report.html \
            --self-contained-html

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            test-report.json
            test-report.html

      - name: Analyze failures
        if: steps.test.outcome == 'failure'
        id: analyze
        run: |
          python << 'PYTHON_EOF'
          import json
          import os
          
          with open('test-report.json', 'r') as f:
              report = json.load(f)
          
          failures = [t for t in report.get('tests', []) if t['outcome'] == 'failed']
          
          summary = f"# üî¥ Test Failures Detected\n\n"
          summary += f"**Commit:** {os.environ['GITHUB_SHA'][:7]}\n"
          summary += f"**Branch:** {os.environ['GITHUB_REF_NAME']}\n"
          summary += f"**Failed Tests:** {len(failures)}\n\n"
          summary += "## Failed Tests\n\n"
          
          for i, failure in enumerate(failures, 1):
              summary += f"### {i}. `{failure['nodeid']}`\n"
              error = failure.get('call', {}).get('longrepr', 'Unknown error')
              summary += f"```\n{error[:500]}\n```\n\n"
          
          with open('failure-summary.md', 'w') as f:
              f.write(summary)
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"failure_count={len(failures)}\n")
          PYTHON_EOF

      - name: Create issue for failures
        if: steps.test.outcome == 'failure'
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('failure-summary.md', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üî¥ Test Failures - ${context.sha.substring(0, 7)}`,
              body: `${summary}\n\n@claude please analyze these test failures and create a PR to fix them.\n\n---\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'automated', 'test-failure']
            });
            
            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

  auto_merge:
    name: Auto-merge Claude's Fix PR
    needs: test
    if: needs.test.outputs.tests_failed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for Claude to create PR
        id: wait_pr
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.test.outputs.issue_number }};
            const maxWaitMinutes = 30;
            const pollIntervalSeconds = 30;
            const maxIterations = (maxWaitMinutes * 60) / pollIntervalSeconds;
            
            console.log(`Waiting for PR linked to issue #${issueNumber}...`);
            
            for (let i = 0; i < maxIterations; i++) {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'created',
                direction: 'desc',
                per_page: 10
              });
              
              const claudePR = prs.find(pr => 
                pr.user.login.includes('claude') && 
                pr.body && pr.body.includes(`#${issueNumber}`)
              );
              
              if (claudePR) {
                console.log(`Found PR #${claudePR.number}`);
                return claudePR.number;
              }
              
              if (i < maxIterations - 1) {
                console.log(`Attempt ${i + 1}/${maxIterations}: No PR yet, waiting ${pollIntervalSeconds}s...`);
                await new Promise(resolve => setTimeout(resolve, pollIntervalSeconds * 1000));
              }
            }
            
            throw new Error('Timeout waiting for Claude to create PR');

      - name: Wait for PR checks to pass
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.wait_pr.outputs.result }};
            const maxWaitMinutes = 15;
            const pollIntervalSeconds = 20;
            const maxIterations = (maxWaitMinutes * 60) / pollIntervalSeconds;
            
            for (let i = 0; i < maxIterations; i++) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });
              
              const allChecks = checks.check_runs;
              const relevantChecks = allChecks.filter(check => 
                check.name !== 'Auto-merge Claude\'s Fix PR'
              );
              
              if (relevantChecks.length > 0) {
                const allComplete = relevantChecks.every(check => 
                  check.status === 'completed'
                );
                const allSuccess = relevantChecks.every(check => 
                  check.conclusion === 'success'
                );
                
                if (allComplete && allSuccess) {
                  console.log('‚úÖ All checks passed!');
                  return true;
                } else if (allComplete && !allSuccess) {
                  throw new Error('Some checks failed');
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, pollIntervalSeconds * 1000));
            }
            
            return false;

      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.wait_pr.outputs.result }};
            const issueNumber = ${{ needs.test.outputs.issue_number }};
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `ü§ñ Auto-fix: Resolve test failures (#${issueNumber})`,
                commit_message: 'Automatically fixed by Claude Code and merged via CI/CD pipeline'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed',
                state_reason: 'completed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚úÖ **Automatically Fixed & Merged**\n\nFixed in PR #${prNumber} and automatically merged.\n\nAll tests are now passing! üéâ`
              });
              
            } catch (error) {
              console.error(`Failed to merge: ${error.message}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ö†Ô∏è PR #${prNumber} was created but auto-merge failed: ${error.message}\n\nPlease review and merge manually.`
              });
              
              throw error;
            }
